var Infomil=Infomil||{};Infomil.Api=Infomil.Api||{};Infomil.Api.Trade=Infomil.Api.Trade||{},function(){var n=".liWMKP001_TradeGenerique.liTrdGen_",i="ulListeProduits",r="liWCRS310_Product",u="divWCRS001_ColonnePrincipale",f=".asideWCRS001_ColonneLaterale",e="Rayon",t="jsWCRS799";this.Outils=function(){this._sIdWidget="xxx";this.GetNbProduits=function(n){var u=0,f,t,o,i,r;if(!n)return 0;for(f=function(n){return n.eTypeProduit==Interfaces.ItfElementProduit.enuTypeProduit.iSTANDARD||n.eTypeProduit==Interfaces.ItfElementProduit.enuTypeProduit.iCOMPOSE||n.eTypeProduit==Interfaces.ItfElementProduit.enuTypeProduit.iACOMPOSER},t=0;t<n.length;t++)if(o=n[t].objElement,i=n[t].lstEnfants,o.sType==e&&i&&i.length>0)for(r=0;r<i.length;r++)f(i[r].objElement)&&u++;else f(o)&&u++;return u};var o=function(n,t){var i={iPosition:0,iNbVignettes:0},l,u,r,v,e,o,s,f,a,h,c;if(window.TradeGeneriqueContext.paramInsertionLevier&&window.TradeGeneriqueContext.paramInsertionLevier[t]&&window.TradeGeneriqueContext.paramInsertionLevier[t].eTypeTrade==Infomil.Api.Trade.Entite.enuTypeTrade.iBANDEAU_EN_TETE)return i.iPosition=0,i;if(l=window.TradeGeneriqueContext.Colonnade,!l)return 0;if(u=l.getColonnade().nb,r=0,n.iLigne&&!n.iIdProduitRattachement&&(o=1,o=!n.niColonne||n.niColonne<1?1:n.niColonne,r=(n.iLigne-1)*u+o-1,v=n.iLigne,e=o),n.iIdProduitRattachement&&(s=window.TradeGeneriqueContext.Datasource,s)){for(f=0;f<s.length;f++)if(s[f].objElement.iIdProduit==n.iIdProduitRattachement){r=f+1;break}if(v=(r-r%u)/u+1,e=r%u+1,e==1)return null}if(window.TradeGeneriqueContext.paramInsertionLevier&&window.TradeGeneriqueContext.paramInsertionLevier[t]){if(a=0,h=0,window.TradeGeneriqueContext.paramInsertionLevier[t].niNbVignettesMin&&(a=window.TradeGeneriqueContext.paramInsertionLevier[t].niNbVignettesMin),window.TradeGeneriqueContext.paramInsertionLevier[t].niNbVignettesMax&&(h=window.TradeGeneriqueContext.paramInsertionLevier[t].niNbVignettesMax),c=u-e+1,i.iNbVignettes=c,c<a)return null;c>h&&(i.iNbVignettes=h);window.TradeGeneriqueContext.objRetourAjax&&window.TradeGeneriqueContext.objRetourAjax[t]&&window.TradeGeneriqueContext.objRetourAjax[t].Contenu&&window.TradeGeneriqueContext.objRetourAjax[t].Contenu.lstProduit&&i.iNbVignettes>window.TradeGeneriqueContext.objRetourAjax[t].Contenu.lstProduit.length&&(i.iNbVignettes=window.TradeGeneriqueContext.objRetourAjax[t].Contenu.lstProduit.length)}return i.iPosition=r,i};this.factoryTradeGeneriqueSTO=function(n,t,i){var u={},f={},r;return n.sIdTradeBusiness&&(u=window.TradeGeneriqueContext.lstTemplates[n.sIdTradeBusiness],f=window.TradeGeneriqueContext.objDatasourcePicto[n.sIdTradeBusiness]),r=new ListesProduits_Trade.jsWCRS744_TradeGeneriqueSTO(n,u,t,i,f),r.rendererProduitBuilder(),r.fonctionnalitesComposer().avecToolTipVignette().avecPopinFicheProduit().avecPlusUnMoinsUn().avecQuantiteMaximaleAtteinteProduit().avecQuantiteMinimaleAtteinteProduit().avecToolTipStickersVignetteProduit().avecStickersVignetteProduit().avecUpselling(),r};this.factoryRecette=function(n,t){var i={};return n.sIdTradeBusiness&&(i=window.TradeGeneriqueContext.lstTemplates[n.sIdTradeBusiness]),new ListesProduits_Trade.jsWCRS617_Recette(n,i,t)};this.GererAffichageTrade=function(t,i){var r=$(n+i)[0];r&&(t?$(r).show():$(r).hide())};this.RedimensionnerTradeGenerique=function(t){var l,s,a,v;if(!window.TradeGeneriqueContext.paramInsertionLevier||!window.TradeGeneriqueContext.paramInsertionLevier[t])return!1;var e=$(n+t)[0],o=$("#"+i+" > li."+r)[0],h=$("."+u),c=window.TradeGeneriqueContext.paramInsertionLevier[t].niNbVignettesMin;return window.TradeGeneriqueContext.iNbVignettesAAfficher&&window.TradeGeneriqueContext.iNbVignettesAAfficher[t]&&(c=window.TradeGeneriqueContext.iNbVignettesAAfficher[t]),e&&(o&&(l=$(o).width(),$(e).width(Math.round(c*l)),$(e).height("0px")),h&&window.TradeGeneriqueContext.paramInsertionLevier[t].eTypeTrade==Infomil.Api.Trade.Entite.enuTypeTrade.iBANDEAU_EN_TETE&&$(e).width($(h).width()),calculHauteurColonneGauche(),s=$(f),s&&o&&(a=$(s).height(),v=$(o).height(),$(s).css({height:v+a}))),!0};this.PositionnerTrade=function(n,t){var i=$.Deferred(),r=this;return Utl.Templates.avecListeVignettesStandard().avecTradeGenerique().avecRecette().load().done(function(u){var f,e,s;window.TradeGeneriqueContext.lstTemplates=window.TradeGeneriqueContext.lstTemplates||{};window.TradeGeneriqueContext.lstTemplates[t]=u;f=o(window.TradeGeneriqueContext.paramInsertionLevier[t].objPosition,t);f?(e=(new ListesProduits_Policies).avec(policy().insertionApresNProduits(f.iPosition).dansLaPage),s=(new ListesProduits_Policies).avec(policy().insertionApresNProduitsPeriodiqueEtDistinct(5).dansLaSousFamilleApres15Produits),n.avecTradeGenerique(e,r.factoryTradeGeneriqueSTO).avecRecette(s,r.factoryRecette),n.sIdTradeBusiness=t,window.TradeGeneriqueContext.iNbVignettesAAfficher=window.TradeGeneriqueContext.iNbVignettesAAfficher||{},window.TradeGeneriqueContext.iNbVignettesAAfficher[t]=f?f.iNbVignettes:0,i.resolve(n)):i.reject()}).fail(function(){i.reject()}),i.promise()};this.RafraichirTradeGenerique=function(n,t){var r=$.Deferred(),f=new Infomil.Api.Trade.Business.TradeBusiness(t),i=window.TradeGeneriqueContext.paramInsertionLevier[t],u;return i&&f?(window.TradeGeneriqueContext.Datasource=n,u=null,u=i.objPosition.iIdProduitRattachement?new Infomil.Api.Trade.Entite.PositionApresProduit(i.objPosition.iIdProduitRattachement):new Infomil.Api.Trade.Entite.PositionFixe(i.objPosition.iLigne,i.objPosition.niColonne),f.DemanderAutorisationInsertionLevier(i.eTypeTrade,i.niNbVignettesMin,u,i.fZoomable).done(function(n){n.EstEnErreur()?r.reject():(window.TradeGeneriqueContext.objTradeBuilder=window.TradeGeneriqueContext.objTradeBuilder||{},window.TradeGeneriqueContext.objTradeBuilder[t]=(new Infomil.Api.Trade.Outils).CreerTradeGeneriqueBuilder(window.TradeGeneriqueContext.objRetourAjax[t],t),r.resolve())}).fail(function(){r.reject()})):r.reject(),r.promise()};this.CreerTradeGeneriqueBuilder=function(n,t){var f,e,r,i,u;if(n||$objDeferred.reject(),f=window.TradeGeneriqueContext.Colonnade,e=window.TradeGeneriqueContext.Provenance,window.TradeGeneriqueContext.objDatasourcePicto=window.TradeGeneriqueContext.objDatasourcePicto||{},window.TradeGeneriqueContext.objDatasourcePicto[t]=n.Contenu&&n.Contenu.objStickers?n.Contenu.objStickers:window.TradeGeneriqueContext.DatasourcePicto,r=[],window.TradeGeneriqueContext.Trade)for(i=0;i<window.TradeGeneriqueContext.Trade.length;i++)window.TradeGeneriqueContext.Trade[i].objElement&&window.TradeGeneriqueContext.Trade[i].objElement.sType.toUpperCase()=="RECETTE"&&r.push(window.TradeGeneriqueContext.Trade[i]);return n.Contenu&&n.Contenu.objContenuElement&&r.push(n.Contenu.objContenuElement),u=new ListesProduits_Trade.jsWCRS696_MapperOperationsTrade(r,e,f),u.sIdTradeBusiness=t,u};this.DemanderAutorisationModeBorne=function(n){return n==Infomil.Api.Trade.Entite.enuTypeTrade.iBANDEAU_COEUR_DE_LISTE?!1:n==Infomil.Api.Trade.Entite.enuTypeTrade.iENCART_COEUR_DE_LISTE?!1:n==Infomil.Api.Trade.Entite.enuTypeTrade.iTETE_GONDOLE?!1:!0};this.ConstruireBanniereModeBorne=function(t,i){var u=$(".divWCAD304_FamilyList"),r,f;u&&(r="",r+="<li class='liWMKP001_TradeGenerique liTrdGen_"+i.sIdTradeBusiness+"' id='sId999' data-trade='gen'>",r+="<ul class='ulWMKP001_TradeGen' id='ulWMKP001_TradeGen'>",r+="<\/ul>",r+="<\/li>",f=$(u).width(),t.sIdBloc="sId999",i.eTypeTrade==Infomil.Api.Trade.Entite.enuTypeTrade.iBANDEAU_EN_TETE&&$(u).children("ul").prepend(r),i.eTypeTrade==Infomil.Api.Trade.Entite.enuTypeTrade.iBANDEAU_FIXE_PIED&&$(u).children("ul").append(r),$(n+i.sIdTradeBusiness).width(f),$(n+i.sIdTradeBusiness).height("0px"))};this.ConstruireCompteRenduInsertion=function(n,t){t.sUrlPageBoutique=n.Context.sUrlPageBoutique;t.niNbProduitsPageBoutique=n.Context.iNbProduitsPageBoutique;t.niNbVignettes=n.Contenu.objContenuElement.lstEnfants.length;n.Contenu&&n.Contenu.lstProduit&&(t.lstIdsProduit=[],n.Contenu.objContenuElement.lstEnfants.forEach(function(n){t.lstIdsProduit.push(new Infomil.Api.Trade.Entite.CRListeProduits(n.objElement.iIdProduit,n.sUuid))}))};this.ConstruirePiedPageFixe=function(n,t){var i,r;".divPiedPageFixeProduits"&&$(".divPiedPageFixeProduits").remove();i="<div class='divPiedPageFixeProduits'>";i+="<li class='liWMKP001_TradeGenerique liTrdGen_"+t.sIdTradeBusiness+"' id='sIdPPF999' data-trade='gen'>";i+="<ul class='ulWMKP001_TradeGen' id='ulWMKP001_TradeGen'>";i+="<\/ul>";i+="<\/li>";i+="<\/div>";r=$("#divContenuCentre").width();n.sIdBloc="sIdPPF999";$(i).prependTo("#divContenuCentre");$(".divPiedPageFixeProduits").width(r);$(".divPiedPageFixeProduits").height("0px");$(".divPiedPageFixeProduits").css("position","absolute")};this.InsererBandeauFixePiedAvecProduit=function(n,i){var f=this,r=new Infomil.Api.Trade.Entite.CRInsertion,e,u;r.CRAutorisation.SetErreur(Infomil.Api.Trade.Entite.enuCRAutorisation.iOK,"","InsererBandeauFixePiedAvecProduit");e={sIdAppelant:t,sIdOperation:n.sIdOperation,niNbProduitsMin:n.niNbProduitsMin,niNbProduitsMax:n.niNbProduitsMax,lstIdsProduits:n.lstIdsProduits,objProprietesPageBoutique:n.objProprietesPageBoutique};u=window.lstConfAjax.RecupererListeProduitsAjax;u&&Utilitaires.Ajax.appeler({context:null,config:u,data:e}).done(function(t){if(t.Message!=""){r.CRAutorisation.SetErreur(Infomil.Api.Trade.Entite.enuCRAutorisation.iKO_AUTRE,t.Message,"InsererBandeauFixePiedAvecProduit");i.reject(r);return}f.ConstruirePiedPageFixe(r,n);Utl.Templates.avecListeVignettesStandard().avecTradeGenerique().avecTemplateAComposer().load().done(function(n){var e,u;!n&&isArray(n)&&r.CRAutorisation.SetErreur(Infomil.Api.Trade.Entite.enuCRAutorisation.iKO_AUTRE,"191128161501 - La liste des lstTemplates doit être un tableau !","InsererBandeauFixePiedAvecProduit");e=new Utl.jsWCRS610_ProvenanceArticle({eOrigine:Utl.jsWCRS610_ProvenanceArticle.enuOrigine.iSITE_COURSES,eTypePage:Utl.jsWCRS610_ProvenanceArticle.enuProvenancePageType.iMODE_BORNE,niIdElement:0,sTexteRecherche:"",eVue:Utl.jsWCRS610_ProvenanceArticle.enuVue.iTRADE_GENERIQUE,iRangAffichage:0,sInformationsComplementaires:null});t&&t.Context&&t.Context.sIdOperation&&(e.sInformationsComplementaires="sto-"+t.Context.sIdOperation);u=new ListesProduits.jsWCRS697_ListeProduitsStandard("ulWMKP001_TradeGen",n,t.Contenu.objContenuElement.lstEnfants,[],Utilitaires.Ressources.vbNETsWCRS201.ascWCRS310_Produits,e,ListesProduits.StrategyColonnade.huitColonnes,t.Contenu.objStickers,Interfaces.jsWCRS642_ItfEvenement.enuTypeContenu.iCONTENU_PRINCIPAL,"10600",null,!0);u.fonctionalitesProduits().avecPopinFicheProduit().avecPlusUnMoinsUn().avecQuantiteMaximaleAtteinteProduit().avecQuantiteMinimaleAtteinteProduit().avecStickersVignetteProduit().avecLimiteLiquideDepassee().avecUpselling();u.renderLayout().listeDeProduit().normal();u.appliquerFonctionnalite();f.ConstruireCompteRenduInsertion(t,r);i.resolve(r);return}).fail(function(){r.CRAutorisation.SetErreur(Infomil.Api.Trade.Entite.enuCRAutorisation.iKO_AUTRE,"191128161500 - Erreur sur le chargement des lstTemplates","InsererBandeauFixePiedAvecProduit");i.reject(r);return})}).fail(function(){r.CRAutorisation.SetErreur(Infomil.Api.Trade.Entite.enuCRAutorisation.iKO_AUTRE,"Erreur Ajax","InsererBandeauFixePiedAvecProduit");i.reject(r);return})};this.InsererTradeModeBorne=function(n,i){var u=this,r=new Infomil.Api.Trade.Entite.CRInsertion,f,o,e;if(r.CRAutorisation.SetErreur(Infomil.Api.Trade.Entite.enuCRAutorisation.iOK,"","InsererLevier"),n.eTypeTrade!=Infomil.Api.Trade.Entite.enuTypeTrade.iBANDEAU_FIXE_PIED&&n.eTypeTrade!=Infomil.Api.Trade.Entite.enuTypeTrade.iBANDEAU_EN_TETE){r.CRAutorisation.SetErreur(Infomil.Api.Trade.Entite.enuCRAutorisation.iKO_AUTRE,"1903271718 - Insertion impossible de ce type de trade en mode Borne","InsererLevier");i.reject(r);return}if($(".liWMKP001_TradeGenerique").remove(),f={sIdAppelant:t,sIdOperation:n.sIdOperation,niNbProduitsMin:n.niNbProduitsMin,niNbProduitsMax:n.niNbProduitsMax,lstIdsProduits:n.lstIdsProduits,objProprietesPageBoutique:n.objProprietesPageBoutique},!f.lstIdsProduits){o={Context:f,Message:"",Contenu:{objContenuElement:{lstEnfants:[]},lstProduit:[],objStickers:{lstProduitsStickers:[],lstStickers:[]}}};u.ConstruireBanniereModeBorne(r,n);u.ConstruireCompteRenduInsertion(o,r);i.resolve(r);return}e=window.lstConfAjax.RecupererListeProduitsAjax;e&&Utilitaires.Ajax.appeler({context:null,config:e,data:f}).done(function(t){if(t.Message!=""){r.CRAutorisation.SetErreur(Infomil.Api.Trade.Entite.enuCRAutorisation.iKO_AUTRE,t.Message,"InsererLevier");i.reject(r);return}u.ConstruireBanniereModeBorne(r,n);var f=$(".ulWMKP001_TradeGen");if(!f){r.CRAutorisation.SetErreur(Infomil.Api.Trade.Entite.enuCRAutorisation.iKO_AUTRE,"191203114000 - Impossible d'insérer la bannière dans la page","InsererTradeModeBorne");i.reject(r);return}Utl.Templates.avecListeVignettesStandard().avecTradeGenerique().avecTemplateAComposer().load().done(function(n){var e,f;!n&&isArray(n)&&r.CRAutorisation.SetErreur(Infomil.Api.Trade.Entite.enuCRAutorisation.iKO_AUTRE,"190327120700 - La liste des lstTemplates doit être un tableau !","InsererTradeModeBorne");e=new Utl.jsWCRS610_ProvenanceArticle({eOrigine:Utl.jsWCRS610_ProvenanceArticle.enuOrigine.iSITE_COURSES,eTypePage:Utl.jsWCRS610_ProvenanceArticle.enuProvenancePageType.iMODE_BORNE,niIdElement:0,sTexteRecherche:"",eVue:Utl.jsWCRS610_ProvenanceArticle.enuVue.iTRADE_GENERIQUE,iRangAffichage:0,sInformationsComplementaires:null});t&&t.Context&&t.Context.sIdOperation&&(e.sInformationsComplementaires="sto-"+t.Context.sIdOperation);f=new ListesProduits.jsWCRS697_ListeProduitsStandard("ulWMKP001_TradeGen",n,t.Contenu.objContenuElement.lstEnfants,[],Utilitaires.Ressources.vbNETsWCRS201.ascWCRS310_Produits,e,ListesProduits.StrategyColonnade.huitColonnes,t.Contenu.objStickers,Interfaces.jsWCRS642_ItfEvenement.enuTypeContenu.iCONTENU_PRINCIPAL,"10600",null,!0);f.fonctionalitesProduits().avecPopinFicheProduit().avecPlusUnMoinsUn().avecQuantiteMaximaleAtteinteProduit().avecQuantiteMinimaleAtteinteProduit().avecStickersVignetteProduit().avecLimiteLiquideDepassee().avecUpselling();f.renderLayout().listeDeProduit().normal();f.appliquerFonctionnalite();u.ConstruireCompteRenduInsertion(t,r);i.resolve(r);return}).fail(function(){r.CRAutorisation.SetErreur(Infomil.Api.Trade.Entite.enuCRAutorisation.iKO_AUTRE,"190327120701 - Erreur sur le chargement des lstTemplates","InsererTradeModeBorne");i.reject(r);return})}).fail(function(){r.CRAutorisation.SetErreur(Infomil.Api.Trade.Entite.enuCRAutorisation.iKO_AUTRE,"Erreur Ajax","InsererTradeModeBorne");i.reject(r);return})};this.InsererBandeauFixePied=function(t,i){var r=new Infomil.Api.Trade.Entite.CRInsertion,u;if(r.CRAutorisation.SetErreur(Infomil.Api.Trade.Entite.enuCRAutorisation.iOK,"","InsererBandeauFixePied"),$(n+t.sIdTradeBusiness)&&$(n+t.sIdTradeBusiness).remove(),u="<div id='sId999' class='divWMKP001_BandeauFixePied' data-trade='gen'><\/div>",$("#divContenuCentre")){$("#divContenuCentre").append(u);$(".divWMKP001_BandeauFixePied").width($("#divContenuCentre").width());$(".divWMKP001_BandeauFixePied").height("0px");$(".footerWCSD001_BasPage")&&$(".footerWCSD001_BasPage").css("margin-bottom",$("#sId999").height()+"px");$(window).on("resize",function(){$(".divWMKP001_BandeauFixePied")&&$(".divWMKP001_BandeauFixePied").width($("#divContenuCentre").width())});r.sIdBloc="sId999";i.resolve(r);return}r.CRAutorisation.SetErreur(Infomil.Api.Trade.Entite.enuCRAutorisation.iKO_AUTRE,"190207090930 - Erreur d'insertion du bandeau","InsererBandeauFixePied");i.reject(r)};this.InsererEncartBandeauRayon=function(n,t){var i=new Infomil.Api.Trade.Entite.CRInsertion,u,f,r;i.CRAutorisation.SetErreur(Infomil.Api.Trade.Entite.enuCRAutorisation.iOK,"","InsererEncartBandeauRayon");try{if(u=n.objPosition,!u.sIdMenuBandeau)throw"190401111800 - Un trade Bandeau Rayon doit être inséré en position sPOSITION_DANS_MENU_BANDEAU";f=$("li[data-sidselection="+u.sIdMenuBandeau+"] #repFamilles .ulWCAD301_Sub");f.length==1&&(r="sIdBR"+n.sIdOperation,$("#"+r).length>0&&$("#"+r).remove(),f.append("<li data-sidselection='"+n.sIdOperation+"' id='"+r+"' ><\/li>"),i.sIdBloc=r)}catch(e){i.CRAutorisation.SetErreur(Infomil.Api.Trade.Entite.enuCRAutorisation.iKO_AUTRE,e,"InsererEncartBandeauRayon");t.reject(i);return}t.resolve(i);return};this.InsererEncartModeBorne=function(n,t){var i=new Infomil.Api.Trade.Entite.CRInsertion,f,r,u;i.CRAutorisation.SetErreur(Infomil.Api.Trade.Entite.enuCRAutorisation.iOK,"","InsererEncartModeBorne");try{if(window.TradeGeneriqueContext.bModeBorne){if(f=$(".divWCAD304_Borne .divWCAD304_FamilyList ul"),f.length!=1)throw"190402122800 - Erreur d'insertion dans le DOM";r="sIdEMB"+n.sIdOperation;$("#"+r).length>0&&$("#"+r).remove();u="";u+="<li id='"+r+"'>";u+="<\/li>";f.append(u);i.sIdBloc=r}else throw"190402103700 - Insertion d'un encart mode borne impossible en dehors du mode borne";}catch(e){i.CRAutorisation.SetErreur(Infomil.Api.Trade.Entite.enuCRAutorisation.iKO_AUTRE,e,"InsererEncartModeBorne");t.reject(i);return}t.resolve(i);return};this.InsererEncartFiltres=function(n,t){var u=new Infomil.Api.Trade.Entite.CRInsertion,e,i,f,r;u.CRAutorisation.SetErreur(Infomil.Api.Trade.Entite.enuCRAutorisation.iOK,"","InsererEncartFiltres");try{if(e=!0,i=$("div.divWCRS315_FiltresNavigation"),i.length!=1&&(i=$("div.divWCRS315_BlocsFiltres"),e=!1),i.length!=1)throw"190521133600 - Erreur d'insertion dans le DOM";f="sIdEFI"+n.sIdOperation;$("#"+f).length>0&&$("#"+f).remove();r="";r+="<div class='divWCRS315_Wrap'>";r+="<ul><li id='"+f+"'><\/li><\/ul>";r+="<\/div>";e?i.after(r):i.before(r);u.sIdBloc=f}catch(o){u.CRAutorisation.SetErreur(Infomil.Api.Trade.Entite.enuCRAutorisation.iKO_AUTRE,o,"InsererEncartModeBorne");t.reject(u);return}t.resolve(u);return}}}.call(Infomil.Api.Trade);