(function(n){this.jsWCRS700_interactionSubstitution=Utilitaires.Class.extend({defaultOptions:{afficherSubstitution:".aWCRS310_Substitute",objProvenanceArticle:null,getTagContainer:null,objDataBase:null,objLoc:null},objProduitIndisponible:null,init:function(t){var i=this;this.options=n.extend({},i.defaultOptions,t);i.options.objProvenanceArticle||Utl.Log.logError("150126112352 - La provenance article ne doit pas être null !")},appliquerFonctionnalite:function(n){var t=this;n.on("click",t.options.afficherSubstitution,function(n){n.preventDefault();n.stopPropagation();t.objProduitIndisponible=t.recupererContenuParEvenementUI(n);t.objProduitIndisponible||Utl.Log.logError("150126034812 - L'objet de données sur lequel s'applique la fonctionnalité ne doit pas être null !");var i=Utl.Loader.afficher();t.recupererDataEtTemplates(t.objProduitIndisponible).done(function(n,r){n[0].lstElements.length===0?window.location.reload():t.ouvrirPopin(t.construireLayout(n,r,t.objProduitIndisponible)).done(function(){Managers.jsWCRS609_MgrEvenement.abonnerEvenement(Interfaces.jsWCRS642_ItfEvenement.enuTypeEvenementServeur.iPRODUIT_AJOUTE,t.fnSubstitutionMonitoring,t);Managers.jsWCRS609_MgrEvenement.abonnerEvenement(Interfaces.jsWCRS642_ItfEvenement.enuTypeEvenementServeur.iPRODUIT_QUANTITE_INCREMENTEE,t.fnSubstitutionMonitoring,t);Managers.jsWCRS609_MgrEvenement.abonnerEvenement(Interfaces.jsWCRS642_ItfEvenement.enuTypeEvenementServeur.iPRODUIT_QUANTITE_DECREMENTEE,t.fnSubstitutionMonitoring,t);Managers.jsWCRS609_MgrEvenement.abonnerEvenement(Interfaces.jsWCRS642_ItfEvenement.enuTypeEvenementServeur.iPRODUIT_SUPPRIME,t.fnSubstitutionMonitoring,t);var n=Interfaces.jsWCRS642_ItfEvenement.avecTypeEvenement(Interfaces.jsWCRS642_ItfEvenement.enuTypeEvenementClient.iOUVERTURE_POPIN_SUBSTITUTION_COURSE).avecElement({objContenu:t.objProduitIndisponible});Managers.jsWCRS609_MgrEvenement.emettreEvenement(n)}).always(function(){i.masquer()})}).fail(function(){Utl.Log.logError("150126013701 - Erreur lors de la récupération des produits de substitutions ou de leur templates !")})})},recupererContenuParEvenementUI:function(n){if(n){var t=this;return t.options.objDataBase.getContenuElementParEvenement(t.options.getTagContainer)(n)}return null},recupererDataEtTemplates:function(t){var r=this,i=n.Deferred();return n.when(r.recupererListeProduitsSubstitution(t),r.recupererListeTemplateSubstitution()).done(function(n,t){i.resolve(n,t)}).fail(function(n){i.reject(n)}),i.promise()},recupererListeProduitsSubstitution:function(n){var t=this,i=t.options.objProvenanceArticle;return Managers.jsWCRS604_MgrPanier.RecupererProduitSubstitution({iIdProduit:n.objElement.sId,sNoPointLivraison:n.objElement.sNoPointLivraison,eTypePage:i.eTypePage})},recupererListeTemplateSubstitution:function(){return Utl.Templates.avecTemplatesSubstitutionPageCourse().load()},construireLayout:function(t,i,r){var u=this,f="popinSubstitutionCourse_"+r.sUuid,e=n(document.createElement("div")),s;e.attr("id",f);e.addClass("divWCRS310_PopinSubstitution");u.options.objProvenanceArticle.eVue=Utl.jsWCRS610_ProvenanceArticle.enuVue.iSUBSTITUTION;s=new ListesProduits_Fonctionnalite.composerFonctionnalites;s.init.dataSource(t[0].lstElements).init.dataSourcePicto(t[1]).init.ajax(window.lstConfAjax).init.localisation(u.options.objLoc).init.provenanceArticle(u.options.objProvenanceArticle).init.templates(i);var c=s.avecToolTipVignette().avecToolTipStickersVignetteProduit().avecPopinFicheProduit({fUpsellingAutorise:!1}).avecQuantiteMaximaleAtteinteProduit().avecQuantiteMinimaleAtteinteProduit().avecPlusUnMoinsUn({objProvenanceArticle:u.options.objProvenanceArticle}).avecStickersVignetteProduit().avecLimiteLiquideDepassee().getAsArray(),l=new ListesProduits_ContenuElements.jsWCRS667_PlusUnMoinsUn(f,i.templatePlusUnMoinsUn),h=new ListesProduits_ContenuElements.jsWCRS648_Vignette(f,i.templateVignetteSubstitution,u.options.objLoc).avecPlusUnMoinsUn(l).avecZonePicto(new ZonePicto(t[1],i)),a={renderElement:function(){var s="",c,l,f,e;if(r.objElement&&(s=h._objZonePicto.renderElement(r.objElement.sId)),c=new Interfaces.ItfElementProduit(null,r.objElement,null,null,s,u.options.objLoc),l=i.templateProduitsIndispoPopinSubstitution.ExecuteTemplate(c),t[0]&&t[0].lstElements){for(var a=[],o=0,v=t[0].lstElements.length;o<v;o++)f=t[0].lstElements[o],e=h.renderElement(f),typeof f.objElement!="undefined"&&f.objElement&&f.objElement.iQuantitePanier>=f.objElement.iQteDisponible&&(e=n(e).addClass("max").prop("outerHTML")),a.push(e);return i.templateCorpsPopinSubstitution.ExecuteTemplate({htmlVignetteProduitIndisponible:l,htmlVignettesProduits:a.join(""),fnSoustitre1:function(n){var t=r.objElement.sLibelleLigne1.concat(r.objElement.sLibelleLigne2?" - "+r.objElement.sLibelleLigne2:"");return String.format(u.options.objLoc.sousTitre1PopinSubstitution,String.format(n,t))},sSoustitre2:u.options.objLoc.sousTitre2PopinSubstitution})}return null}},o=new ListesProduits_Renderer.jsWCRS675_RendererLayout(f,new Array(t),e,c,Interfaces.jsWCRS642_ItfEvenement.enuTypeContenu.iCONTENU_PRINCIPAL);return o.initLayout(a),o.htmlEntete=i.templateEntetePopinSubstitution.ExecuteTemplate({sTitrePopin:u.objProduitIndisponible.objElement.iQuantitePanier===0?u.options.objLoc.titrePopinSubstitution:u.options.objLoc.titrePopinSubstitutionProduitDejaPresent}),o.contenuToolpin=e,o},ouvrirPopin:function(t){var i=this,r=n.Deferred();return WCTD201.Class.PopinManager.OuvrirPopin({fClient:!0,conteneurType:WCTD201.Class.PopinModele,conteneur:{fTitreSeparateur:!1,titre:t.htmlEntete,contenu:t.contenuToolpin},sNomPopin:"popinSubstitutionProduitCourse",popin:{iMaxHeight:730,fFermerAvecCroix:!0,fFermerAvecEchap:!0,fFermerAvecFade:!0,sOnComplete:function(){r.resolve()},sOnFermer:function(){var n=null;n=i.objProduitIndisponible.qteSubstitution&&i.objProduitIndisponible.qteSubstitution>0?Interfaces.jsWCRS642_ItfEvenement.avecTypeEvenement(Interfaces.jsWCRS642_ItfEvenement.enuTypeEvenementClient.iPRODUIT_REMPLACE_POPIN_SUBSTITUTION_COURSE).avecElement({objProduit:i.objProduitIndisponible.objElement}):Interfaces.jsWCRS642_ItfEvenement.avecTypeEvenement(Interfaces.jsWCRS642_ItfEvenement.enuTypeEvenementClient.iPRODUIT_NON_REMPLACE_POPIN_SUBSTITUTION_COURSE).avecElement({objProduit:i.objProduitIndisponible.objElement});Managers.jsWCRS609_MgrEvenement.emettreEvenement(n);t&&t.dispose&&t.dispose()}}}),r.promise()},fnSubstitutionMonitoring:function(n){var t=this;t.objProduitIndisponible.qteSubstitution||(t.objProduitIndisponible.qteSubstitution=0);switch(n.eTypeEvenement){case Interfaces.jsWCRS642_ItfEvenement.enuTypeEvenementServeur.iPRODUIT_AJOUTE:t.objProduitIndisponible.qteSubstitution=1;break;case Interfaces.jsWCRS642_ItfEvenement.enuTypeEvenementServeur.iPRODUIT_QUANTITE_INCREMENTEE:t.objProduitIndisponible.qteSubstitution+=1;break;case Interfaces.jsWCRS642_ItfEvenement.enuTypeEvenementServeur.iPRODUIT_QUANTITE_DECREMENTEE:t.objProduitIndisponible.qteSubstitution-=1;t.objProduitIndisponible.qteSubstitution<1&&(t.objProduitIndisponible.qteSubstitution=0);break;case Interfaces.jsWCRS642_ItfEvenement.enuTypeEvenementServeur.iPRODUIT_SUPPRIME:t.objProduitIndisponible.qteSubstitution=0;break;default:Utl.Log.logWarn("150220094104 - Produit de substitution : fnSubstitutionMonitoring evenement non geré !")}},disposerFonctionnalite:function(n){var t=this;n.off("click",this.options.afficherSubstitution);Managers.jsWCRS609_MgrEvenement.desabonnerEvenement(Interfaces.jsWCRS642_ItfEvenement.enuTypeEvenementServeur.iPRODUIT_AJOUTE,t.fnSubstitutionMonitoring,this);Managers.jsWCRS609_MgrEvenement.desabonnerEvenement(Interfaces.jsWCRS642_ItfEvenement.enuTypeEvenementServeur.iPRODUIT_QUANTITE_INCREMENTEE,t.fnSubstitutionMonitoring,this);Managers.jsWCRS609_MgrEvenement.desabonnerEvenement(Interfaces.jsWCRS642_ItfEvenement.enuTypeEvenementServeur.iPRODUIT_SUPPRIME,t.fnSubstitutionMonitoring,this);Managers.jsWCRS609_MgrEvenement.desabonnerEvenement(Interfaces.jsWCRS642_ItfEvenement.enuTypeEvenementServeur.iPRODUIT_QUANTITE_DECREMENTEE,t.fnSubstitutionMonitoring,this)}})}).call(this.ListesProduits_Fonctionnalite_InteractionsPanier=this.ListesProduits_Fonctionnalite_InteractionsPanier||{__namespace:!0},window.jQuery);typeof Sys!="undefined"&&Sys.Application.notifyScriptLoaded();